---
title: "Final_Project"
author: "shawn"
date: "December 5, 2014"
output: html_document
---

Description:

##1. Read-in and Format Data
Converts multi sheet excel document to single data-frame with m/z,intensity,relative intensity, and sample names and ribotype (or another feature) as variables. The multi-sheet excel document is the easiest and fastest way to export spectra data from the Flex Analysis program in the clinical lab. 
These read-in and data-formatting functions are useful because they are much faster than copying-and pasting columns into new spreadsheets, and this method is less error prone. These are good qualities, especially if you have a target plate with 96 samples. 

```{r}
#first, load all of the packages/libraries you will need to use this package
library(XLConnect)
library(MALDIquant)

```
First read-in multi-sheet excel document
```{r}
#1. Converts multi sheet excel doc to single data-frame with m/z,intensity, 
#load XLConnect package to read in Excel files
importWorksheets <- function(file) {
  # filename: name of Excel file
  workbook <- loadWorkbook(file)
  sheet_names <- getSheets(workbook)
  names(sheet_names) <- sheet_names
  sheet_list <- lapply(sheet_names, function(.sheet){
    readWorksheet(object=workbook, .sheet)})
}
###
importWorksheets("11-20-2014_SEW.xls")
```
Next, convert all of the sheets from the Excel document into a single list containing all of the spectra from each sample (Excel workbook sheet) as an element of the list. This function returns the list containing spectra called spectra.list to the global environment. It also returns a list of the samples (Excel worksheet headings) that can be referenced for labling and creating dataframes later.
```{r}
#This function converts all of the sheets from an excel file as a single list
#returns a list called spectra.list containing all sheets in excel file to global enironment
#returns sheet names so user can create dataframes containing peak lists of interest
Return.spectra.list<-function(file){
  spectra.list<-importWorksheets(file)
  spectra.list<-as.vector(spectra.list)
  spectra.names<<-names(spectra.list)
  return(spectra.names)
}
###
Return.spectra.list("11-20-2014_SEW.xls")
```
The next step is to create dataframes for the spectra that you are interested in. The names are returned for your convenience in labeling your files

```{r}
# example code, not in a function

#create dataframes for spectra of interest
#could try to turn this into a function, 
#make.spectra.df<-function(list, sample) {
  #list<<-as.data.frame(list$(paste('sample')))
 # }

#not sure if that would be too hard with data frame naming scheme
#examples of how to do it manually w/out function
#control BTS
BTS<-as.data.frame(spectra.list$'BTS_0_A9_1')
#strain 2398
s2398_1.1<-as.data.frame(spectra.list$'2398_1-1_0_A5_1')
s2398_1.2<-as.data.frame(spectra.list$'2398_1-2_0_B5_1')
s2398_3.1<-as.data.frame(spectra.list$'2398_3-1_0_E5_1')
#strain 630g
s630_1.1<-as.data.frame(spectra.list$'630_1-1_0_A6_1')
s630_2.1<-as.data.frame(spectra.list$'630_2-1_0_C6_1')
s630_2.2<-as.data.frame(spectra.list$'630_2-2_0_D6_1')
s630_3.1<-as.data.frame(spectra.list$'630_3-1_0_E6_1')
s630_3.2<-as.data.frame(spectra.list$'630_3-2_0_F6_1')
#strain VPI
VPI_1.1<-as.data.frame(spectra.list$'VPI_1-1_0_A2_1')
VPI_1.2<-as.data.frame(spectra.list$'VPI_1-2_0_B2_1')
VPI_2.1<-as.data.frame(spectra.list$'VPI_2-1_0_C2_1')
VPI_2.2<-as.data.frame(spectra.list$'VPI_2-2_0_D2_1')
VPI_3.1<-as.data.frame(spectra.list$'VPI_3-1_0_E2_1')
VPI_3.2<-as.data.frame(spectra.list$'VPI_3-2_0_F2_1')
#strain F200
F200_1.1<-as.data.frame(spectra.list$'F200_1-1_0_A1_1')
F200_1.2<-as.data.frame(spectra.list$'F2001-2_0_B1_1')
F200_2.1<-as.data.frame(spectra.list$'F200_2-1_0_C1_1')
F200_2.2<-as.data.frame(spectra.list$'F200_2-2_0_D1_1')
F200_3.1<-as.data.frame(spectra.list$'F200_3-1_0_E1_1')
F200_3.2<-as.data.frame(spectra.list$'F200_3-2_0_F1_1')
#strain R20291
R20291_2.1<-as.data.frame(spectra.list$'R20291_2-1_0_C3_1')
R20291_2.2<-as.data.frame(spectra.list$'R20291_2-2_0_D3_1')
#strain 712
s712_1.1<-as.data.frame(spectra.list$'712_1-1_0_A4_1')
s712_1.2<-as.data.frame(spectra.list$'712_1-2_0_B4_1')
s712_2.1<-as.data.frame(spectra.list$'712_2-1_0_C4_1')
s712_2.2<-as.data.frame(spectra.list$'712_2-2_0_D4_1')
s712_3.1<-as.data.frame(spectra.list$'712_3-1_0_E4_1')
s712_3.2<-as.data.frame(spectra.list$'712_3-2_0_F4_1')

  
```
Then you will want to format your dataframe to eliminate empty rows and columns from the Excel sheet. This function takes a dataframe and sample name as arguments and deletes unnecessary rows and columns.

```{r}
#function to format data so that dataframe contains only m/z time and intensity
#takes dataframe and sample name (can be different than dataframe name)
#as argument and deletes unnecessary info

format.spectra.df<-function(data.frame, sample, ribotype){
  data.frame<-data.frame[ ,-c(4:7,9:11)] #remove columns that aren't needed
  data.frame<-data.frame[-c(1:2), ] #remove rows that aren't needed
  names(data.frame)<-NULL #delete the variable names since they are wrong
  colnames(data.frame)<-c("m/z","time","intensity","rel.intensity") #rename
  data.frame$sample<-sample #make put the sample name in the sample column
  data.frame$ribotype<-ribotype #add the ribotype or other feature
  write.table(data.frame,file=(paste0(sample, ".txt"))) #write this to a txt file in working directory
}
####
#BTS control
format.spectra.df(BTS, "BTS", "BTS")
#strain 2398
format.spectra.df(s2398_1.1, "s2398_1.1", "027")
format.spectra.df(s2398_1.2, "s2398_1.2", "027")
format.spectra.df(s2398_3.1, "s2398_3.1", "027")
#strain 630g
format.spectra.df(s630_1.1,"s630_1.1", "012")
format.spectra.df(s630_2.1,"s630_2.1", "012")
format.spectra.df(s630_2.2,"s630_2.2", "012")
format.spectra.df(s630_3.1,"s630_3.1", "012")
format.spectra.df(s630_3.2,"s630_3.2", "012")
#strain VPI
format.spectra.df(VPI_1.1, "VPI_1.1", "003")
format.spectra.df(VPI_1.2, "VPI_1.2", "003")
format.spectra.df(VPI_2.1, "VPI_2.1", "003")
format.spectra.df(VPI_2.2, "VPI_2.2", "003")
format.spectra.df(VPI_3.1, "VPI_3.1", "003")
format.spectra.df(VPI_3.2, "VPI_3.2", "003")
#strain F200
format.spectra.df(F200_1.1, "F200_1.1", "UM12")
format.spectra.df(F200_1.2, "F200_1.2", "UM12")
format.spectra.df(F200_2.1, "F200_2.1", "UM12")
format.spectra.df(F200_2.2, "F200_2.2", "UM12")
format.spectra.df(F200_3.1, "F200_3.1", "UM12")
format.spectra.df(F200_3.2, "F200_3.2", "UM12")
#strain R20291
format.spectra.df(R20291_2.1, "R20291_2.1", "027")
format.spectra.df(R20291_2.2, "R20291_2.2", "027")
#strain 712
format.spectra.df(s712_1.1, "s712_1.1", "003")
format.spectra.df(s712_1.2, "s712_1.2", "003")
format.spectra.df(s712_2.1, "s712_2.1", "003")
format.spectra.df(s712_2.2, "s712_2.2", "003")
format.spectra.df(s712_3.1, "s712_3.1", "003")
format.spectra.df(s712_3.2, "s712_3.2", "003")
```
Now you should have a separate txt file in your working directory for each sample that you want to look at. The next step is to bring the files back in as dataframes. 
```{r}
#not in a function

#bring samples back in 
#BTS control
BTS<-read.table(file="BTS.txt", header=T)

#strain 2398
s2398_1.1<-read.table(file="s2398_1.1.txt", header=T)
s2398_1.2<-read.table(file="s2398_1.2.txt", header=T)
s2398_3.1<-read.table(file="s2398_3.1.txt", header=T)

#strain 630g
s630_1.1<-read.table(file="s630_1.1.txt", header=T)
s630_2.1<-read.table(file="s630_2.1.txt", header=T)
s630_2.2<-read.table(file="s630_2.2.txt", header=T)
s630_3.1<-read.table(file="s630_3.1.txt", header=T)
s630_3.2<-read.table(file="s630_3.2.txt", header=T)

#strain VPI
VPI_1.1<-read.table(file="VPI_1.1.txt", header=T)
VPI_1.2<-read.table(file="VPI_1.2.txt", header=T)
VPI_2.1<-read.table(file="VPI_2.1.txt", header=T)
VPI_2.2<-read.table(file="VPI_2.2.txt", header=T)
VPI_3.1<-read.table(file="VPI_3.1.txt", header=T)
VPI_3.2<-read.table(file="VPI_3.2.txt", header=T)

#strain F200
F200_1.1<-read.table(file="F200_1.1.txt", header=T)
F200_1.2<-read.table(file="F200_1.2.txt", header=T)
F200_2.1<-read.table(file="F200_2.1.txt", header=T)
F200_2.2<-read.table(file="F200_2.2.txt", header=T)
F200_3.1<-read.table(file="F200_3.1.txt", header=T)
F200_3.2<-read.table(file="F200_3.2.txt", header=T)

#strain R20291
R20291_2.1<-read.table(file="F200_2.1.txt", header=T)
R20291_2.2<-read.table(file="F200_2.2.txt", header=T)


#strain 712
s712_1.1<-read.table(file="s712_1.1.txt", header=T)
s712_1.2<-read.table(file="s712_1.2.txt", header=T)
s712_2.1<-read.table(file="s712_2.1.txt", header=T)
s712_2.2<-read.table(file="s712_2.2.txt", header=T)
s712_3.1<-read.table(file="s712_3.1.txt", header=T)
s712_3.2<-read.table(file="s712_3.2.txt", header=T)

```
Congrats! Your dataframes are now formatted in a way that makes sense, and the data are ready for you to make plots and run statistics. If you would like to combine all of your spectra data frames into a single dataframe, you can use the following code
code below
```{r}
#merge all dataframes to one big dataframe with the variables of interest
all.spectra.df<-rbind()

#####
all.spectra<-rbind(s2398_1.1 , s2398_1.2 , s2398_3.1 , s630_1.1 , s630_2.1 , s630_2.2 , s630_3.1 , s630_3.2 , VPI_1.1 , VPI_1.2 , VPI_2.1 , VPI_2.2 , VPI_3.1, VPI_3.2 , F200_1.1 , F200_1.2 , F200_2.1 , F200_2.2 , F200_3.1 , F200_3.2 , R20291_2.1 , R20291_2.2 , s712_1.1 , s712_1.2 , s712_2.1 , s712_2.2 , s712_3.1, s712_3.2)

```
##2.Plots intensity by m/z
These functions can be used to quickly plot your spectra to get a rough idea of what your data looks like. 
plot.spectra.rel.intens offers a pre-formatted m/z by relative intensity plot. Plot.spectra.intens similarly returns a pre-formatted m/z by intensity plot. These functions are usefull to see your data quickly.

```{r} 

plot.spectra.rel.intens<-function(df=data.frame) {
plot(df$rel.intensity~df$m.z, type="l", main="Relative Intensity by M/Z", xlab="M/Z", ylab="Relative Intensity" , xlim=c(2000,13000), ylim=c(0,1),col="black")
}

Plot.spectra.intens<-function(df=data.frame) {
plot(df$intensity~df$m.z, type="l", main="Intensity by M/Z", xlab="M/Z", ylab="Intensity" , xlim=c(2000,13000), ylim=c(0,15000),col="black")
}

#####
Plot.spectra.intens(BTS)
plot.spectra.rel.intens()
plot.spectra.rel.intens(BTS)
#overlay other 027s
#2398
lines(s2398_1.2$rel.intensity~s2398_1.2$m.z, type="l", col="red")
lines(s2398_1.1$rel.intensity~s2398_1.1$m.z, type="l", col="red")
lines(s2398_3.1$rel.intensity~s2398_3.1$m.z, type="l", col="red")
#R20291
lines(R20291_2.1$rel.intensity~R20291_2.2$m.z, type="l", col="red")
lines(R20291_2.2$rel.intensity~R20291_2.2$m.z, type="l", col="red")

#overlay F200 non-tox strain
lines(F200_1.1$rel.intensity~F200_1.1$m.z, type="l", col="green")
lines(F200_1.2$rel.intensity~F200_1.2$m.z, type="l", col="green")
lines(F200_2.1$rel.intensity~F200_2.1$m.z, type="l", col="green")
lines(F200_2.2$rel.intensity~F200_2.2$m.z, type="l", col="green")
lines(F200_3.1$rel.intensity~F200_3.1$m.z, type="l", col="green")
lines(F200_3.2$rel.intensity~F200_3.2$m.z, type="l", col="green")

#630
lines(s630_1.1$rel.intensity~s630_1.1$m.z, type="l", col="blue")
lines(s630_1.2$rel.intensity~s630_1.2$m.z, type="l", col="blue")
lines(s630_2.1$rel.intensity~s630_2.1$m.z, type="l", col="blue")
lines(s630_2.2$rel.intensity~s630_2.2$m.z, type="l", col="blue")
lines(s630_3.1$rel.intensity~s630_3.1$m.z, type="l", col="blue")
lines(s630_3.2$rel.intensity~s630_3.2$m.z, type="l", col="blue")
#712
lines(s712_1.1$rel.intensity~s712_1.1$m.z, type="l", col="orange")
lines(s712_2.1$rel.intensity~s712_2.1$m.z, type="l", col="orange")
lines(s712_2.2$rel.intensity~s712_2.2$m.z, type="l", col="orange")
lines(s712_3.1$rel.intensity~s712_3.1$m.z, type="l", col="orange")
lines(s712_3.2$rel.intensity~s712_3.2$m.z, type="l", col="orange")

#VPI
lines(VPI_1.1$rel.intensity~VPI_1.1$m.z, type="l", col="purple")
lines(VPI_1.2$rel.intensity~VPI_1.2$m.z, type="l", col="purple")
lines(VPI_2.1$rel.intensity~VPI_2.1$m.z, type="l", col="purple")
lines(VPI_2.2$rel.intensity~VPI_2.2$m.z, type="l", col="purple")
lines(VPI_3.1$rel.intensity~VPI_3.1$m.z, type="l", col="purple")
lines(VPI_3.2$rel.intensity~VPI_3.2$m.z, type="l", col="purple")

```
##3.Statistics to compare spectra
Does stats to compare peaks between spectra
-not sure what best measure(s) is yetâ€¦
```{r}



```
##4.Unique Peak Finding Analysis
```{r}

#testing MALDIquant method for baseline subtraction

 

```
##5. Bilds Tree 

```{r}
#going to need to convert to wide format to have each value of variable (m/z) as a column, and samples as a row.
#s2398_1.1$count<-c(1:51)
#test<-subset(s2398_1.1, select=c("m.z","count"))
#fix.shape<-reshape(test, timevar="count", idvar=c("m.z"), direction="wide")

#then the tree will make sense
#test tree
#first combine dataframes
#three.spectra<-rbind(s2398_1.1$, s2398_1.2,s2398_3.1)
#put them into wide format
#three.spectra<-
# prepare hierarchical cluster
#hc = hclust(dist(three.spectra$m.z), "ave")
# very simple dendrogram
#plot(hc)
#hc = hclust(dist(s2398_1.1$m.z), "ave")
#plot(hc)
```

