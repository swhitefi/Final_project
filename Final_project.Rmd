---
title: "Final_Project"
author: "shawn"
date: "December 5, 2014"
output: html_document
---

Description:

##1. Read-in and Format Data
Converts multi sheet excel document to single data-frame with m/z,intensity,relative intensity, and sample names and ribotype (or another feature) as variables. The multi-sheet excel document is the easiest and fastest way to export spectra data from the Flex Analysis program in the clinical lab. 
These read-in and data-formatting functions are useful because they are much faster than copying-and pasting columns into new spreadsheets, and this method is less error prone. These are good qualities, especially if you have a target plate with 96 samples. 

```{r}
#first, load all of the packages/libraries you will need to use this package
library(XLConnect)

```
First read-in multi-sheet excel document
```{r}
#1. Converts multi sheet excel doc to single data-frame with m/z,intensity, 
#load XLConnect package to read in Excel files
importWorksheets <- function(file) {
  # filename: name of Excel file
  workbook <- loadWorkbook(file)
  sheet_names <- getSheets(workbook)
  names(sheet_names) <- sheet_names
  sheet_list <- lapply(sheet_names, function(.sheet){
    readWorksheet(object=workbook, .sheet)})
}
###
importWorksheets("11-20-2014_SEW.xls")
```
Next, convert all of the sheets from the Excel document into a single list containing all of the spectra from each sample (Excel workbook sheet) as an element of the list. This function returns the list containing spectra called spectra.list to the global environment. It also returns a list of the samples (Excel worksheet headings) that can be referenced for labling and creating dataframes later.
```{r}
#This function converts all of the sheets from an excel file as a single list
#returns a list called spectra.list containing all sheets in excel file to global enironment
#returns sheet names so user can create dataframes containing peak lists of interest
Return.spectra.list<-function(file){
  spectra.list<-importWorksheets(file)
  spectra.list<-as.vector(spectra.list)
  spectra.names<<-names(spectra.list)
  return(spectra.names)
}
###
Return.spectra.list("11-20-2014_SEW.xls")
```
The next step is to create dataframes for the spectra that you are interested in.

```{r}
# example code, not in a function

#create dataframes for spectra of interest
#could try to turn this into a function, 
#make.spectra.df<-function(list, sample) {
  #list<<-as.data.frame(list$(paste('sample')))
 # }

#not sure if that would be too hard with data frame naming scheme
#examples of how to do it manually w/out function
#strain 2398
s2398_1.1<-as.data.frame(spectra.list$'2398_1-1_0_A5_1')
s2398_1.2<-as.data.frame(spectra.list$'2398_1-2_0_B5_1')
s2398_3.1<-as.data.frame(spectra.list$'2398_3-1_0_E5_1')
#strain 630g

#strain 712
#strain F200
#strain R20291
#strain VPI

```
Then you will want to format your dataframe to eliminate empty rows and columns from the Excel sheet. This function takes a dataframe and sample name as arguments and deletes unnecessary rows and columns.

```{r}
#function to format data so that dataframe contains only m/z time and intensity
#takes dataframe and sample name (can be different than dataframe name)
#as argument and deletes unnecessary info

format.spectra.df<-function(data.frame, sample, ribotype){
  data.frame<-data.frame[ ,-c(4:7,9:11)] #remove columns that aren't needed
  data.frame<-data.frame[-c(1:2), ] #remove rows that aren't needed
  names(data.frame)<-NULL #delete the variable names since they are wrong
  colnames(data.frame)<-c("m/z","time","intensity","rel.intensity") #rename
  data.frame$sample<-sample #make put the sample name in the sample column
  data.frame$ribotype<-ribotype #add the ribotype or other feature
  write.table(data.frame,file=(paste0(sample, ".txt"))) #write this to a txt file in working directory
}
####
format.spectra.df(s2398_1.1, "2398_1.1", "027")
format.spectra.df(s2398_1.2, "2398_1.2", "027")
format.spectra.df(s2398_3.1, "2398_3.1", "027")
```
Now you should have a separate txt file in your working directory for each sample that you want to look at. The next step is to bring the files back in as dataframes. 
```{r}
#not in a function
#bring samples back in 
s2398_1.1<-read.table(file="2398_1.1.txt", header=T)
s2398_1.2<-read.table(file="2398_1.2.txt", header=T)
s2398_3.1<-read.table(file="2398_3.1.txt", header=T)
```
Congrats! Your dataframes are now formatted in a way that makes sense, and the data are ready for you to make plots and run statistics. 
```{r}

```
##2.Plots intensity by m/z
These functions can be used to quickly plot your spectra to get a rough idea of what your data looks like. 
```{r}
plot.spectra<-function(df){
plot(df$rel.intensity~df$m.z, type="l", main="Relative Intensity by M/Z", xlab="M/Z", ylab="Relative Intensity" , xlim=c(2000,13000), ylim=c(0,1),col=rainbow(30))
}
##
plot.spectra(s2398_1.2)
```
##3.Statistics to compare spectra
Does stats to compare peaks between spectra
-not sure what best measure(s) is yetâ€¦
```{r}

```
##4.Unique Peak Finding Analysis
```{r}

```
##5. Bilds Tree 

```{r}
#going to need to convert to wide format to have each value of variable (m/z) as a column, and samples as a row.
s2398_1.1$count<-c(1:51)
test<-subset(s2398_1.1, select=c("m.z","count"))
fix.shape<-reshape(test, timevar="count", idvar=c("m.z"), direction="wide")

#then the tree will make sense
#test tree
#first combine dataframes
three.spectra<-rbind(s2398_1.1$, s2398_1.2,s2398_3.1)
#put them into wide format
three.spectra<-
# prepare hierarchical cluster
hc = hclust(dist(three.spectra$m.z), "ave")
# very simple dendrogram
plot(hc)
hc = hclust(dist(s2398_1.1$m.z), "ave")
plot(hc)
```

